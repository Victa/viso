<!DOCTYPE html>  <html> <head>   <title>viso.rb</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               viso.rb             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <h2>Viso</h2>

<p><strong>Viso</strong> is a simple Sinatra app that displays CloudApp Drops. Images are
displayed front and center, bookmarks are redirected to their destination, and
a download button is provided for all other file types.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="n">require_relative</span> <span class="s1">&#39;drop&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;json&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;sinatra/base&#39;</span>

<span class="k">class</span> <span class="nc">Viso</span> <span class="o">&lt;</span> <span class="no">Sinatra</span><span class="o">::</span><span class="no">Base</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Load New Relic RPM in the production and staging environments.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="n">configure</span><span class="p">(</span><span class="ss">:production</span><span class="p">,</span> <span class="ss">:staging</span><span class="p">)</span> <span class="p">{</span> <span class="nb">require</span> <span class="s1">&#39;newrelic_rpm&#39;</span> <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Serve static assets from <code>/public</code></p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="n">set</span> <span class="ss">:public</span><span class="p">,</span> <span class="s1">&#39;public&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Bring in some helper methods from Rack to aid in escaping HTML.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="n">helpers</span> <span class="p">{</span> <span class="kp">include</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Utils</span> <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>The home page. Nothing to see here. Redirect to the CloudApp product page.
Response is cached for one year.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="n">get</span> <span class="s1">&#39;/&#39;</span> <span class="k">do</span>
    <span class="n">cache_control</span> <span class="ss">:public</span><span class="p">,</span> <span class="ss">:max_age</span> <span class="o">=&gt;</span> <span class="mi">31557600</span>
    <span class="n">redirect</span> <span class="s1">&#39;http://getcloudapp.com&#39;</span>
  <span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Redirect to the public app's favicon. Response is cached for one year.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="n">get</span> <span class="s1">&#39;/favicon.ico&#39;</span> <span class="k">do</span>
    <span class="n">cache_control</span> <span class="ss">:public</span><span class="p">,</span> <span class="ss">:max_age</span> <span class="o">=&gt;</span> <span class="mi">31557600</span>
    <span class="n">redirect</span> <span class="s1">&#39;http://my.cl.ly/favicon.ico&#39;</span>
  <span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Handle a JSON request for a <strong>Drop</strong>. Return the same data received from the
CloudApp API. Response is cached for 15 minutes.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="n">get</span> <span class="s1">&#39;/:slug&#39;</span><span class="p">,</span> <span class="ss">:provides</span> <span class="o">=&gt;</span> <span class="s1">&#39;json&#39;</span> <span class="k">do</span> <span class="o">|</span><span class="n">slug</span><span class="o">|</span>
    <span class="n">drop</span> <span class="o">=</span> <span class="n">find_drop</span> <span class="n">slug</span>

    <span class="n">cache_control</span> <span class="ss">:public</span><span class="p">,</span> <span class="ss">:max_age</span> <span class="o">=&gt;</span> <span class="mi">900</span>
    <span class="n">content_type</span>  <span class="ss">:json</span>

    <span class="no">JSON</span><span class="o">.</span><span class="n">generate</span> <span class="n">drop</span><span class="o">.</span><span class="n">data</span>
  <span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>The main responder for a <strong>Drop</strong>. Redirect to the bookmark's link, render
the image view for an image, or render the generic download view for
everything else. Response is cached for 15 minutes.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="n">get</span> <span class="s1">&#39;/:slug&#39;</span> <span class="k">do</span> <span class="o">|</span><span class="n">slug</span><span class="o">|</span>
    <span class="vi">@drop</span> <span class="o">=</span> <span class="n">find_drop</span> <span class="n">slug</span>
    <span class="n">cache_control</span> <span class="ss">:public</span><span class="p">,</span> <span class="ss">:max_age</span> <span class="o">=&gt;</span> <span class="mi">900</span>

    <span class="k">if</span> <span class="vi">@drop</span><span class="o">.</span><span class="n">bookmark?</span>
      <span class="n">redirect_to_api</span>
    <span class="k">else</span>
      <span class="n">erb</span> <span class="vi">@drop</span><span class="o">.</span><span class="n">image?</span> <span class="p">?</span> <span class="ss">:image</span> <span class="p">:</span> <span class="ss">:download</span>
    <span class="k">end</span>
  <span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>The content for a <strong>Drop</strong>. Redirect to the identical path on the API domain
where the view counter is incremented and the visitor is redirected to the
actual URL of file. Response is cached for 15 minutes.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="n">get</span> <span class="s1">&#39;/:slug/:filename&#39;</span> <span class="k">do</span> <span class="o">|</span><span class="n">slug</span><span class="p">,</span> <span class="n">filename</span><span class="o">|</span>
    <span class="n">cache_control</span> <span class="ss">:public</span><span class="p">,</span> <span class="ss">:max_age</span> <span class="o">=&gt;</span> <span class="mi">900</span>
    <span class="n">redirect_to_api</span>
  <span class="k">end</span>

<span class="kp">protected</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Find and return a <strong>Drop</strong> with the given <code>slug</code>. Handle <code>Drop::NotFound</code>
errors and render the not found response.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">def</span> <span class="nf">find_drop</span><span class="p">(</span><span class="n">slug</span><span class="p">)</span>
    <span class="no">Drop</span><span class="o">.</span><span class="n">find</span> <span class="n">slug</span>
  <span class="k">rescue</span> <span class="no">Drop</span><span class="o">::</span><span class="no">NotFound</span>
    <span class="n">not_found</span>
  <span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Redirect the current request to the same path on the API domain.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">def</span> <span class="nf">redirect_to_api</span>
    <span class="n">redirect</span> <span class="s2">&quot;</span><span class="si">#{</span> <span class="no">Drop</span><span class="o">.</span><span class="n">base_uri</span> <span class="si">}#{</span> <span class="n">request</span><span class="o">.</span><span class="n">path</span> <span class="si">}</span><span class="s2">&quot;</span>
  <span class="k">end</span>

<span class="k">end</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 