<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>viso.rb</title>
  <link rel="stylesheet" href="http://jashkenas.github.com/docco/resources/docco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <table cellspacing=0 cellpadding=0>
  <thead>
    <tr>
      <th class=docs><h1>viso.rb</h1></th>
      <th class=code></th>
    </tr>
  </thead>
  <tbody>
    <tr id='section-Viso'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Viso">&#182;</a>
        </div>
        <h2>Viso</h2>

<p><strong>Viso</strong> is the magic that powers <a href="http://getcloudapp.com">CloudApp</a> by displaying shared Drops. At
its core, <strong>Viso</strong> is a simple <a href="https://github.com/sinatra/sinatra">Sinatra</a> app that retrieves a <strong>Drop&rsquo;s</strong>
details using the <a href="http://developer.getcloudapp.com">CloudApp API</a>. Images are displayed front and center,
bookmarks are redirected to their destination, markdown is processed by
<a href="https://github.com/tanoku/redcarpet">RedCarpet</a>, code files are highlighted by <a href="http://pygments.org">Pygments</a>, and, when all else
fails, a download button is provided. <strong>Viso</strong> uses <a href="https://github.com/eventmachine/eventmachine">eventmachine</a> and
<a href="https://github.com/mperham/rack-fiber_pool">rack-fiber_pool</a> to serve requests while expensive network I/O is performed
asynchronously.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nb">require</span> <span class="s1">&#39;eventmachine&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;sinatra/base&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;sinatra/respond_with&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;yajl&#39;</span>

<span class="n">require_relative</span> <span class="s1">&#39;drop&#39;</span>
<span class="n">require_relative</span> <span class="s1">&#39;domain&#39;</span>

<span class="k">class</span> <span class="nc">Viso</span> <span class="o">&lt;</span> <span class="no">Sinatra</span><span class="o">::</span><span class="no">Base</span></pre></div>
      </td>
    </tr>
    <tr id='section-2'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-2">&#182;</a>
        </div>
        <p>Make use of <code>respond_to</code> to handle content negotiation.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">register</span> <span class="no">Sinatra</span><span class="o">::</span><span class="no">RespondWith</span></pre></div>
      </td>
    </tr>
    <tr id='section-3'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-3">&#182;</a>
        </div>
        <p>Load New Relic RPM and Hoptoad in the production and staging environments.
Add your Hoptoad API key to the environment variable <code>HOPTOAD_API_KEY</code> and
Hoptoad will catalog your exceptions. Explicitly require some bits from
<code>activesupport</code> that Hoptoad needs.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">configure</span><span class="p">(</span><span class="ss">:production</span><span class="p">,</span> <span class="ss">:staging</span><span class="p">)</span> <span class="k">do</span>
    <span class="nb">require</span> <span class="s1">&#39;newrelic_rpm&#39;</span>
    <span class="n">require_relative</span> <span class="s1">&#39;newrelic_instrumentation&#39;</span>

    <span class="k">if</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;HOPTOAD_API_KEY&#39;</span><span class="o">]</span>
      <span class="nb">require</span> <span class="s1">&#39;active_support&#39;</span>
      <span class="nb">require</span> <span class="s1">&#39;active_support/core_ext/object/blank&#39;</span>
      <span class="nb">require</span> <span class="s1">&#39;hoptoad_notifier&#39;</span>

      <span class="no">HoptoadNotifier</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
        <span class="n">config</span><span class="o">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;HOPTOAD_API_KEY&#39;</span><span class="o">]</span>
      <span class="k">end</span>

      <span class="n">use</span> <span class="no">HoptoadNotifier</span><span class="o">::</span><span class="no">Rack</span>
      <span class="n">enable</span> <span class="ss">:raise_errors</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">configure</span> <span class="ss">:development</span> <span class="k">do</span>
    <span class="nb">require</span> <span class="s1">&#39;new_relic/control&#39;</span>
    <span class="no">NewRelic</span><span class="o">::</span><span class="no">Control</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">init_plugin</span> <span class="s1">&#39;developer_mode&#39;</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span>
      <span class="ss">:env</span> <span class="o">=&gt;</span> <span class="s1">&#39;development&#39;</span>

    <span class="nb">require</span> <span class="s1">&#39;new_relic/rack/developer_mode&#39;</span>
    <span class="n">use</span> <span class="no">NewRelic</span><span class="o">::</span><span class="no">Rack</span><span class="o">::</span><span class="no">DeveloperMode</span>

    <span class="n">require_relative</span> <span class="s1">&#39;newrelic_instrumentation&#39;</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-4'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-4">&#182;</a>
        </div>
        <p>Use a fiber pool to serve <strong>Viso</strong> when outside of the test environment.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">configure</span> <span class="k">do</span>
    <span class="k">unless</span> <span class="nb">test</span><span class="p">?</span>
      <span class="nb">require</span> <span class="s1">&#39;rack/fiber_pool&#39;</span>
      <span class="n">use</span> <span class="no">Rack</span><span class="o">::</span><span class="no">FiberPool</span>
    <span class="k">end</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-5'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-5">&#182;</a>
        </div>
        <p>Serve static assets from <code>/public</code></p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">set</span> <span class="ss">:public</span><span class="p">,</span> <span class="s1">&#39;public&#39;</span></pre></div>
      </td>
    </tr>
    <tr id='section-6'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-6">&#182;</a>
        </div>
        <p>Bring in some helper methods from Rack to aid in escaping HTML.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">helpers</span> <span class="p">{</span> <span class="kp">include</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Utils</span> <span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-7'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-7">&#182;</a>
        </div>
        <p>Cached responses are only valid for a specific accept header.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">before</span> <span class="p">{</span> <span class="n">headers</span><span class="o">[</span><span class="s1">&#39;Vary&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;Accept&#39;</span> <span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-8'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-8">&#182;</a>
        </div>
        <p>The home page. Custom domain users have the option to set a home page so
ping the API to get the home page for the current domain. Response is cached
for one hour.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">get</span> <span class="s1">&#39;/&#39;</span> <span class="k">do</span>
    <span class="n">cache_control</span> <span class="ss">:public</span><span class="p">,</span> <span class="ss">:max_age</span> <span class="o">=&gt;</span> <span class="mi">3600</span>
    <span class="n">redirect</span> <span class="no">Domain</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">env</span><span class="o">[</span><span class="s1">&#39;HTTP_HOST&#39;</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">home_page</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-9'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-9">&#182;</a>
        </div>
        <p>The main responder for a <strong>Drop</strong>. Responds to both JSON and HTML and
response is cached for 15 minutes.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">get</span> <span class="sr">%r{^/([^/?#]+)(?:/o)?$}</span> <span class="k">do</span> <span class="o">|</span><span class="n">slug</span><span class="o">|</span>
    <span class="k">begin</span>
      <span class="vi">@drop</span> <span class="o">=</span> <span class="n">find_drop</span> <span class="n">slug</span>
      <span class="n">cache_control</span> <span class="ss">:public</span><span class="p">,</span> <span class="ss">:max_age</span> <span class="o">=&gt;</span> <span class="mi">900</span>

      <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span></pre></div>
      </td>
    </tr>
    <tr id='section-10'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-10">&#182;</a>
        </div>
        <p>Redirect to the bookmark&rsquo;s link, render the image view for an image, or
render the generic download view for everything else.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="nb">format</span><span class="o">.</span><span class="n">html</span> <span class="k">do</span>
          <span class="k">if</span> <span class="vi">@drop</span><span class="o">.</span><span class="n">bookmark?</span>
            <span class="n">redirect_to_api</span>
          <span class="k">else</span>
            <span class="n">erb</span> <span class="n">drop_template</span><span class="p">,</span> <span class="ss">:locals</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:body_id</span> <span class="o">=&gt;</span> <span class="n">body_id</span> <span class="p">}</span>
          <span class="k">end</span>
        <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-11'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-11">&#182;</a>
        </div>
        <p>Handle a JSON request for a <strong>Drop</strong>. Return the same data received from
the CloudApp API.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="nb">format</span><span class="o">.</span><span class="n">json</span> <span class="k">do</span>
          <span class="no">Yajl</span><span class="o">::</span><span class="no">Encoder</span><span class="o">.</span><span class="n">encode</span> <span class="vi">@drop</span><span class="o">.</span><span class="n">data</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">rescue</span> <span class="o">=&gt;</span> <span class="n">e</span>
      <span class="n">env</span><span class="o">[</span><span class="s1">&#39;async.callback&#39;</span><span class="o">].</span><span class="n">call</span> <span class="o">[</span> <span class="mi">500</span><span class="p">,</span> <span class="p">{},</span> <span class="s1">&#39;Internal Server Error&#39;</span> <span class="o">]</span>
      <span class="no">HoptoadNotifier</span><span class="o">.</span><span class="n">notify_or_ignore</span> <span class="n">e</span> <span class="k">if</span> <span class="n">defined?</span> <span class="no">HoptoadNotifier</span>
    <span class="k">end</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-12'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-12">&#182;</a>
        </div>
        <p>The content for a <strong>Drop</strong>. Redirect to the identical path on the API domain
where the view counter is incremented and the visitor is redirected to the
actual URL of file. Response is cached for 15 minutes.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">get</span> <span class="s1">&#39;/:slug/:filename&#39;</span> <span class="k">do</span> <span class="o">|</span><span class="n">slug</span><span class="p">,</span> <span class="n">filename</span><span class="o">|</span>
    <span class="n">cache_control</span> <span class="ss">:public</span><span class="p">,</span> <span class="ss">:max_age</span> <span class="o">=&gt;</span> <span class="mi">900</span>
    <span class="n">redirect_to_api</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-13'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-13">&#182;</a>
        </div>
        <p>Don&rsquo;t need to return anything special for a 404.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">not_found</span> <span class="k">do</span>
    <span class="n">not_found</span> <span class="s1">&#39;&lt;h1&gt;Not Found&lt;/h1&gt;&#39;</span>
  <span class="k">end</span>


<span class="kp">protected</span></pre></div>
      </td>
    </tr>
    <tr id='section-14'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-14">&#182;</a>
        </div>
        <p>Find and return a <strong>Drop</strong> with the given <code>slug</code>. Handle <code>Drop::NotFound</code>
errors and render the not found response.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">def</span> <span class="nf">find_drop</span><span class="p">(</span><span class="n">slug</span><span class="p">)</span>
    <span class="no">Drop</span><span class="o">.</span><span class="n">find</span> <span class="n">slug</span>
  <span class="k">rescue</span> <span class="no">Drop</span><span class="o">::</span><span class="no">NotFound</span>
    <span class="n">not_found</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-15'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-15">&#182;</a>
        </div>
        <p>Redirect the current request to the same path on the API domain.</p>

      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">def</span> <span class="nf">redirect_to_api</span>
    <span class="n">redirect</span> <span class="s2">&quot;http://</span><span class="si">#{</span> <span class="no">Drop</span><span class="o">.</span><span class="n">base_uri</span> <span class="si">}#{</span> <span class="n">request</span><span class="o">.</span><span class="n">path</span> <span class="si">}</span><span class="s2">&quot;</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">drop_template</span>
    <span class="k">if</span> <span class="vi">@drop</span><span class="o">.</span><span class="n">image?</span>
      <span class="ss">:image</span>
    <span class="k">elsif</span> <span class="vi">@drop</span><span class="o">.</span><span class="n">text?</span>
      <span class="ss">:text</span>
    <span class="k">else</span>
      <span class="ss">:other</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">body_id</span>
    <span class="k">if</span> <span class="vi">@drop</span><span class="o">.</span><span class="n">image?</span>
      <span class="s1">&#39;image&#39;</span>
    <span class="k">elsif</span> <span class="vi">@drop</span><span class="o">.</span><span class="n">text?</span>
      <span class="s1">&#39;text&#39;</span>
    <span class="k">else</span>
      <span class="s1">&#39;other&#39;</span>
    <span class="k">end</span>
  <span class="k">end</span>

<span class="k">end</span></pre></div>
      </td>
    </tr>
  </table>
</div>
</body>
